# ahooks useRequest 数据共享机制详解

## 🤔 问题：文档中的这句话是什么意思？

> "如果没有发起新请求，不会触发数据共享。cacheTime、staleTime 参数会使数据共享失效。"

## 📚 核心概念解释

### 1. 数据共享的前提条件

ahooks useRequest 的数据共享机制有一个**关键前提**：
- **只有当组件发起新的网络请求时，才会触发数据共享**
- 如果组件没有发起新请求，就不会共享数据

### 2. 缓存参数的影响

#### cacheTime（缓存时间）
```javascript
useRequest(getData, {
  cacheKey: 'shared-data',
  cacheTime: 5 * 60 * 1000, // 5分钟
})
```

**影响**：
- 在5分钟内，如果再次使用相同的 `cacheKey`，**不会发起新请求**
- 不发起新请求 = 不触发数据共享
- 组件会直接使用缓存的数据

#### staleTime（新鲜时间）
```javascript
useRequest(getData, {
  cacheKey: 'shared-data',
  staleTime: 30 * 1000, // 30秒
})
```

**影响**：
- 在30秒内，数据被认为是"新鲜的"
- 新鲜数据不会发起新请求
- 不发起新请求 = 不触发数据共享

## 🎯 实际场景演示

### 场景1：会触发数据共享的情况

```javascript
// 组件A
const { data } = useRequest(getData, {
  cacheKey: 'shared-data',
  cacheTime: 0,    // 不缓存
  staleTime: 0,    // 不保持新鲜
})

// 组件B
const { data } = useRequest(getData, {
  cacheKey: 'shared-data',
  cacheTime: 0,
  staleTime: 0,
})
```

**结果**：两个组件都会发起新请求，会触发数据共享

### 场景2：不会触发数据共享的情况

```javascript
// 组件A（先挂载）
const { data } = useRequest(getData, {
  cacheKey: 'shared-data',
  cacheTime: 5 * 60 * 1000, // 5分钟缓存
  staleTime: 30 * 1000,     // 30秒新鲜
})

// 组件B（后挂载，在30秒内）
const { data } = useRequest(getData, {
  cacheKey: 'shared-data',
  cacheTime: 5 * 60 * 1000,
  staleTime: 30 * 1000,
})
```

**结果**：
- 组件A发起请求，获取数据
- 组件B挂载时，由于数据还在新鲜时间内，**不会发起新请求**
- 组件B直接使用缓存数据，**不会触发数据共享**

## 🔍 详细分析

### 数据共享的触发条件

1. **必须发起新请求** ✅
2. **使用相同的 cacheKey** ✅
3. **请求成功完成** ✅

### 不会触发数据共享的情况

1. **使用缓存数据** ❌
   - cacheTime 内
   - staleTime 内
   - 手动设置 cacheKey 但数据已存在

2. **请求失败** ❌
   - 网络错误
   - 服务器错误

3. **不同的 cacheKey** ❌
   - 即使请求相同的数据

## 💡 实际应用建议

### 1. 需要数据共享的场景
```javascript
// 实时数据，需要多个组件同步
const { data } = useRequest(getRealTimeData, {
  cacheKey: 'realtime-data',
  cacheTime: 0,        // 不缓存
  staleTime: 0,        // 不保持新鲜
  refreshInterval: 5000, // 每5秒刷新
})
```

### 2. 不需要数据共享的场景
```javascript
// 静态数据，可以缓存
const { data } = useRequest(getStaticData, {
  cacheKey: 'static-data',
  cacheTime: 10 * 60 * 1000, // 10分钟缓存
  staleTime: 5 * 60 * 1000,  // 5分钟新鲜
})
```

### 3. 混合场景
```javascript
// 需要共享但也要缓存
const { data } = useRequest(getData, {
  cacheKey: 'mixed-data',
  cacheTime: 2 * 60 * 1000,  // 2分钟缓存
  staleTime: 0,              // 不保持新鲜，总是重新验证
})
```

## 🧪 测试方法

1. 打开演示页面：`http://localhost:3000/demo`
2. 观察两个组件的请求次数
3. 切换组件的显示/隐藏
4. 对比有无缓存配置的差异

## 📝 总结

ahooks 的数据共享机制是为了**避免重复请求**而设计的。当数据在缓存或新鲜时间内时，组件不会发起新请求，因此也不会触发数据共享。这是为了性能优化，但需要开发者理解这个机制，避免在需要实时数据同步的场景中误用缓存参数。
