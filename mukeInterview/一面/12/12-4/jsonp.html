<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>jsonp æ¼”ç¤º</title>

  <style>

  </style>
</head>

<body>
  <div>99</div>
  <!-- callbackçš„åå­—ä¹Ÿä¸æ˜¯å›ºå®šçš„ -->
  <script>

  </script>

  <!-- jsonp.jså¯ä»¥æ ¹æ®å…¥å‚åŠ¨æ€è¿”å› -->
  <!-- <script src="http://localhost:8082/jsonp.js"></script> -->

  <script>
    /**
     * callbackName :åªéœ€è¦passå‡½æ•°åç§°ï¼Œå‡½æ•°æ˜¯åœ¨fetchjsonpå‡½æ•°é‡Œé¢å®šä¹‰çš„
     * æ“ä½œdom:document.body.appendChild(script);
     * document.body.removeChild(script);
     * ç§»é™¤å…¨å±€å˜é‡ delete window[callbackName]
    */


    function jsonp({ url, params, callbackName }) {
      let search = ''
      Object.entries(params).map(([key, value]) => {
        return search += `${key}=${encodeURIComponent(value)}&`
      })
      // ä¿®æ”¹1ï¼šæœåŠ¡å™¨ç«¯å›ºå®šè°ƒç”¨'callback'ï¼Œæ‰€ä»¥URLå‚æ•°ä¹Ÿæ˜¯callback
      const fetchUrl = `${url}?${search}callback=${callbackName}`;
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = fetchUrl;
        script.id = fetchUrl;
        document.body.appendChild(script);
        // ä¿®æ”¹2ï¼šæœåŠ¡å™¨ç«¯è°ƒç”¨çš„æ˜¯'callback'è¿™ä¸ªå­—ç¬¦ä¸²åç§°çš„å‡½æ•°
        window[callbackName] = (data) => {
          console.log('ğŸ”¥ window.callback è¢«è°ƒç”¨äº†ï¼', data);
          resolve(data);
          console.log('callback outter data', data)
          // ä¿®æ”¹4ï¼šæ­£ç¡®åˆ é™¤scriptæ ‡ç­¾
          document.body.removeChild(script);
          // ä¿®æ”¹5ï¼šæ¸…ç†å…¨å±€å›è°ƒå‡½æ•°
          delete window[callbackName];
        }
      })
    }

    jsonp({ url: 'http://localhost:8082/jsonp.js', params: { name: 'emily', time: '0712' }, callbackName: 'callback' })
  </script>
</body>

</html>